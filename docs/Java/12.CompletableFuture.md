# CompletableFuture

- [1. ìë°” Concurrent í”„ë¡œê·¸ë˜ë° ì†Œê°œ](#1-ìë°”-concurrent-í”„ë¡œê·¸ë˜ë°-ì†Œê°œ)
    - [1-1. Concurrent ì†Œí”„íŠ¸ì›¨ì–´](#1-1-concurrent-ì†Œí”„íŠ¸ì›¨ì–´)
- [2. Executors](#2-executors)
    - [2-1. Executorsê°€ í•˜ëŠ” ì¼](#2-1-executorsê°€-í•˜ëŠ”-ì¼)
    - [2-2. ì£¼ìš” ì¸í„°í˜ì´ìŠ¤](#2-2-ì£¼ìš”-ì¸í„°í˜ì´ìŠ¤)
    - [2-3. ì˜ˆì œ](#2-3-ì˜ˆì œ)
    - [2-4. Executor ì •ë¦¬](#2-4-executor-ì •ë¦¬)
- [3. Callableê³¼ Future](#3-callableê³¼-future)
    - [3-1. Callable](#3-1-callable)
    - [3-2. Future](#3-2-future)
    - [3-3. ë©”ì†Œë“œ ì‚´í´ë³´ê¸°](#3-3-ë©”ì†Œë“œ-ì‚´í´ë³´ê¸°)
- [4. CompletableFuture (1)](#4-completablefuture-1)
    - [4-1. ê°œìš”](#4-1-ê°œìš”)
    - [4-2. CompletableFuture](#4-2-completablefuture)
- [5. CompletableFuture (2)](#5-completablefuture-2)
    - [5-1. CompletableFuture ì¡°í•© ë©”ì†Œë“œ](#5-1-completablefuture-ì¡°í•©-ë©”ì†Œë“œ)
    - [5-2. ì˜ˆì™¸ ì²˜ë¦¬ ë©”ì†Œë“œ](#5-2-ì˜ˆì™¸-ì²˜ë¦¬-ë©”ì†Œë“œ)
    - [5-3. CompletableFuture ë¥¼ ì–¸ì œ ì“¸ ìˆ˜ ìˆì„ê¹Œ](#5-3-completablefuture-ë¥¼-ì–¸ì œ-ì“¸-ìˆ˜-ìˆì„ê¹Œ)

## 1. ìë°” Concurrent í”„ë¡œê·¸ë˜ë° ì†Œê°œ

### 1-1. Concurrent ì†Œí”„íŠ¸ì›¨ì–´

> ğŸ’¡ ë™ì‹œì— ì—¬ëŸ¬ ì‘ì—…ì„ í•  ìˆ˜ ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´

#### ë™ì‹œì„±ê³¼ ë³‘ë ¬ì„±ì˜ ì°¨ì´

- ë™ì‹œì„±
    - í•˜ë‚˜ì˜ ì“°ë ˆë“œë‚˜ í”„ë¡œì„¸ì„œì˜ ì—¬ëŸ¬ Taskë¥¼ ê´€ë¦¬í•¨ìœ¼ë¡œì¨, ë§ˆì¹˜ ë™ì‹œì— ì‘ì—…ì´ ìˆ˜í–‰ë˜ê³  ìˆëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ëŠ” ê²ƒ
- ë³‘ë ¬ì„±
    - Taskì˜ ì‹¤í–‰ì„ í•˜ë“œì›¨ì–´ ìˆ˜ì¤€ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, ê°ê°ì˜ ì‘ì—…ë“¤ì´ ë…ë¦½ì ì„

#### 1-1-1. ìë°”ì—ì„œ ì§€ì›í•˜ëŠ” Concurrent í”„ë¡œê·¸ë˜ë°

- ë©€í‹°ì“°ë ˆë“œ
- ë©€í‹°í”„ë¡œì„¸ì‹±(ProcessBuilder)

|     `ë²„ì „`  	|                                 `ì‚¬ìš© ë°©ë²•`                                  	|
| :-----------:	|:---------------------------------------------------------------------------:	|
|  Java 5 ì´ì „ 	|                      Runnableê³¼ Threadë¥¼ ì´ìš©í•˜ì—¬ êµ¬í˜„                      	|
|    Java 5   	|                      ExecutorService, Callable, Future                      	|
|    Java 7   	|                        Fork/Join ê·¸ë¦¬ê³  RecursiveTask                       	|
|    Java 8   	|                          Stream, CompletableFuture                          	|
|    Java 9   	| ë¶„ì‚° ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì€ ëª…ì‹œì ìœ¼ë¡œ ì§€ì› (ë°œí–‰ êµ¬ë… í”„ë¡œí† ì½œ ì§€ì› Flow API) 	|

#### 1-1-2. ìë°” ë©€í‹°ì“°ë ˆë“œ í”„ë¡œê·¸ë˜ë°

- Thread/Runnable

    ```java
    public class App {
        public static void main(String[] args) {
    				// ì²«ë²ˆì§¸ ë°©ë²•
            MyThread myThread = new MyThread();
            myThread.start();
    
            // Anonymous class
            Thread runnable = new Thread(new Runnable() {
                @Override
                public void run() {
                    System.out.println("Runnable Thread: " + Thread.currentThread().getName());
                }
            });
    
            // Lambda Expression
            Thread lambdaThread = new Thread(() -> System.out.println("Lambda Thread:" + Thread.currentThread().getName()));
    
            System.out.println("Hello: "+Thread.currentThread().getName());
        }
    
        // Thread ìƒì†
        static class MyThread extends Thread {
            @Override
            public void run() {
                System.out.println("Thread: "+Thread.currentThread().getName());
            }
        }
    }
    
    /* ì‹¤í–‰ê²°ê³¼
    Hello: main
    Thread: Thread-0
    */
    ```

    - ì½”ë“œì˜ ì‹¤í–‰ ìˆœì„œë§Œ ë´ì„œëŠ” Threadê°€ ë¨¼ì € ì¶œë ¥ë˜ì•¼ í•  ê²ƒ ê°™ì§€ë§Œ, ì‹¤ì œë¡œ ì‹¤í–‰í•´ë³´ë©´ ë‹¤ë¥´ê²Œ ì¶œë ¥ë  ë•Œë„ ìˆë‹¤.
    - ì´ë¥¼ í†µí•´ ThreadëŠ” ìˆœì„œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

ì—¬ê¸°ì„  ë¡œì»¬í´ë˜ìŠ¤ë¥¼ ì´ìš©í–ˆì§€ë§Œ, ìµëª…í´ë˜ìŠ¤ì™€ ëŒë‹¤í‘œí˜„ì‹ì„ ì´ìš©í•´ì„œë„ ì ìš©í•  ìˆ˜ ìˆë‹¤.

#### 1-1-3. ì£¼ìš”ê¸°ëŠ¥(method)

1. **sleep(*mills*)**
    - í˜„ì¬ ì“°ë ˆë“œ ì¬ìš°ê¸°(ë©ˆì¶°ë‘ê¸°)
        - ìŠ¤ë ˆë“œë¥¼ ëŒ€ê¸°ìƒíƒœë¡œ ë©ˆì¶°ì„œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•¨.
        - í•˜ì§€ë§Œ ë½ì„ ë†”ì£¼ì§„ ì•Šê¸°ì— ì˜ëª»í•˜ë©´ ë°ë“œë½ ìƒíƒœì— ê±¸ë¦´ ìˆ˜ ìˆë‹¤.

    ```java
    public static void main(String[] args) throws InterruptedException {
        // Lambda Expression
        Thread lambdaThread = new Thread(() -> {
            try {
                Thread.sleep(1000L);
            } catch(InterruptedException e){
                System.out.println("interrupted!");
                return;
            }
            System.out.println("Thread: "+Thread.currentThread().getName());
        });
        lambdaThread.start();
    
        System.out.println("Hello: "+Thread.currentThread().getName());
    }
    ```

   **Thread.sleep(1000L)**

    - Threadë¥¼ startí•˜ë©´ 1ì´ˆ(1000L)ë™ì•ˆ ë©ˆì¶°ìˆê³  ê·¸ ë™ì•ˆ ë‹¤ë¥¸ ì“°ë ˆë“œë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— Helloê°€ í•­ìƒ ìš°ì„  ì¶œë ¥ëœë‹¤.

2. **interrupt()**
    - ë‹¤ë¥¸ ì“°ë ˆë“œë¥¼ ê¹¨ìš°ê¸°
        - `InterruptException` ì„ ë°œìƒ
        - ì´ ì—ëŸ¬ì— ëŒ€í•œ í•¸ë“¤ë§ì€ êµ¬í˜„ ê°€ëŠ¥

    ```java
    public static void main(String[] args) throws InterruptedException {
        // Lambda Expression
        Thread lambdaThread = new Thread(() -> {
            try {
                Thread.sleep(3000L);
            } catch(InterruptedException e){
                System.out.println("interrupted!");
                return;
            }
            System.out.println("Thread: "+Thread.currentThread().getName());
        });
        lambdaThread.start();
    
        lambdaThread.interrupt();
        System.out.println("Hello: "+Thread.currentThread().getName());
    }
    ```

   **lambdaThread.interrupt();**

    - lambdaThreadì— interrupt()ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ lambdaThreadë‚´ì— InterruptedException ì„ ë°œìƒì‹œí‚¨ë‹¤.

3. **join()**
    - ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤.

    ```java
    public static void main(String[] args) throws InterruptedException {
        //Lambda Expression
        Thread lambdaThread = new Thread(() -> {
            try {
                Thread.sleep(3000L);
            } catch(InterruptedException e){
                System.out.println("interrupted!");
                return;
            }
            System.out.println("Thread: "+Thread.currentThread().getName());
        });
        lambdaThread.start();
    
        lambdaThread.join();
        System.out.println("Hello: "+Thread.currentThread().getName());
    }
    ```

   **lambdaThread.join();**

    - lambdaThreadì— join()ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ lambdaThreadê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤.

## 2. Executors

> Runnableì´ë‚˜ Threadì™€ ê°™ì€ Low-levelì´ ì•„ë‹Œ ê³  ìˆ˜ì¤€(High-Level) Concurrency í”„ë¡œê·¸ë˜ë°

ìš°ë¦¬ê°€ Runnableë§Œ ì •ì˜í•´ì„œ ì œê³µí•´ì£¼ë©´ ìŠ¤ë ˆë“œë¥¼ ë§Œë“¤ê³ , ë¶ˆí•„ìš”í•´ì§€ë©´ ì¢…ë£Œí•˜ê³  ê´€ë¦¬í•´ì£¼ëŠ” ì‘ì—…ë“¤ì„ ëŒ€ì‹  í•´ì£¼ëŠ” í´ë˜ìŠ¤

### 2-1. Executorsê°€ í•˜ëŠ” ì¼

- ì“°ë ˆë“œ ë§Œë“¤ê¸°: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‚¬ìš©í•  ì“°ë ˆë“œ í’€ì„ ë§Œë“¤ì–´ê´€ë¦¬í•œë‹¤.
- ì“°ë ˆë“œ ê´€ë¦¬: ì“°ë ˆë“œ ìƒëª… ì£¼ê¸°ë¥¼ ê´€ë¦¬í•œë‹¤.
- ì‘ì—… ì²˜ë¦¬ ë° ì‹¤í–‰: ì“°ë ˆë“œë¡œ ì‹¤í–‰í•  ì‘ì—…ì„ ì œê³µí•  ìˆ˜ ìˆëŠ” APIë¥¼ ì œê³µí•œë‹¤.

### 2-2. ì£¼ìš” ì¸í„°í˜ì´ìŠ¤

- `Executor`:  execute(Runnable)
- `ExecutorService`: Executorë¥¼ ìƒì† ë°›ì€ ì¸í„°í˜ì´ìŠ¤ë¡œ, Callableë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©° Executorë¥¼ ì¢…ë£Œ ì‹œí‚¤ê±°ë‚˜ ì—¬ëŸ¬  Callableì„ ë™ì‹œì— ì‹¤í–‰í•˜ëŠ” ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.
- `ScheduledExecutorService`: ExecutorServiceë¥¼ ìƒì† ë°›ì€ ì¸í„°í˜ì´ìŠ¤ë¡œ íŠ¹ì • ì‹œê°„ ì´í›„ì— ë˜ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ì‘ì—… ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

### 2-3. ì˜ˆì œ

#### 2-3-1. ê¸°ë³¸ ì‚¬ìš© ì˜ˆì œ

```java
public static void main(String[] args) throws InterruptedException {
		// ExecutorService ìƒì„±
    ExecutorService executorService = Executors.newSingleThreadExecutor();
    
    // Legacy case
    executorService.execute(new Runnable() {
        @Override
        public void run() {
            System.out.println("Thread: "+Thread.currentThread().getName());
        }
    });
    // Lambda Expression
    executorService.submit(()->{
        System.out.println("Lambda Expression Thread: "+Thread.currentThread().getName());
    });

    executorService.shutdown(); // graceful shutdown
    // executorService.shutdownNow(); //ì¦‰ì‹œ ì¢…ë£Œ
}
```

#### 2-3-2. 2ê°œì˜ Threadë¥¼ ì´ìš©í•˜ì—¬ ì‹¤í–‰

```java
public class App {
    private static Runnable getRunnable(String message) {
        return () -> System.out.println(message + Thread.currentThread().getName());
    }

    public static void main(String[] args) throws InterruptedException {
        ExecutorService executorService = Executors.newFixedThreadPool(2);

        executorService.submit(getRunnable("Hello"));
        executorService.submit(getRunnable("World"));
        executorService.submit(getRunnable("The"));
        executorService.submit(getRunnable("Java"));
        executorService.submit(getRunnable("Lecture"));
        executorService.submit(getRunnable("Concurrent"));
        executorService.submit(getRunnable("Part"));

        executorService.shutdown(); //graceful shutdown
    }
}
/* ì‹¤í–‰ê²°ê³¼
Hellopool-1-thread-1
Worldpool-1-thread-2
Javapool-1-thread-2
Thepool-1-thread-1
Lecturepool-1-thread-2
Concurrentpool-1-thread-1
Partpool-1-thread-2
*/
```

**Executors.newFixedThreadPool(2)**

- í•´ë‹¹ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ ì˜ì—­ì—ëŠ” ì¸ìê°’ìœ¼ë¡œ ë„˜ê²¨ì¤€ ìˆ«ìë§Œí¼ Threadë¥¼ ê´€ë¦¬í•œë‹¤.
- ìœ„ ì½”ë“œì—ì„œëŠ” 2ë¥¼ ì¸ìê°’ìœ¼ë¡œ ë„˜ê²¨ì¤¬ê¸° ë•Œë¬¸ì— 2ê°œì˜ 2ê°œì˜ ì“°ë ˆë“œë¥¼ ê´€ë¦¬í•˜ëŠ” Thread Poolì´ ë„ëŠ” ë™ì•ˆ Blocking Queueì— ë“±ë¡ëœ ì‘ì—…ë“¤ì´ ì°¨ë¡€ëŒ€ë¡œ ë™ì‘í•œë‹¤.

<img src = "https://user-images.githubusercontent.com/42997924/142423017-14bf66d4-c249-4982-b9bc-19d13f3aa048.png" width="75%" height="75%">

ì¶œì²˜ : [https://catsbi.oopy.io/50d5af24-a724-40a1-981b-a9f00ff521ad#638f51da-ae38-4574-baf5-d4f331ee6fbe](https://www.notion.so/50d5af24a72440a1981ba9f00ff521ad)


**ExecutorService.newSingleThreadScheduledExcutor();**

```java
ScheduledExecutorService executorService = Executors.newSingleThreadScheduledExecutor();
executorService.scheduleAtFixedRate(getRunnable("hello"), 3, 1, TimeUnit.SECONDS);
```

- scheduleAtFixedRate(ì‹¤í–‰ Runnable, ì‹œì‘ ì§€ì—° ì‹œê°„, ë”œë ˆì´, íŒŒë¼ë¯¸í„° ì‹œê°„ ë‹¨ìœ„)
- ìœ„ ì½”ë“œëŠ” Runnableíƒ€ì…ì„ ë°˜í™˜í•˜ëŠ” getRunnable() ë©”ì†Œë“œë¥¼ í”„ë¡œê·¸ë¨ì´ ì‹œì‘ í›„ 3ì´ˆ ë’¤ë¶€í„° 1ì´ˆë§ˆë‹¤ ìˆ˜í–‰í•˜ëŠ” ì½”ë“œ

### 2-4. Executor ì •ë¦¬

- `supplyAsync` ë“±ì˜ ë©”ì†Œë“œ í˜¸ì¶œì‹œ ì“°ë ˆë“œ í’€ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ [Java ForkJoinPool](https://kwonnam.pe.kr/wiki/java/concurrent/forkjoinpool) ì˜ `commonPool()` ì´ ì‚¬ìš©ëœë‹¤.
- ê°œë°œìê°€ ì“°ë ˆë“œ í’€ì„ ì œì–´í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì€ ë‚˜ì¤‘ì— ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ, í•­ìƒ [Java ExecutorService](https://kwonnam.pe.kr/wiki/java/concurrent/executorservice) ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì“°ë ˆë“œ í’€ì„ ì§€ì •í•˜ë„ë¡ í•œë‹¤.

## 3. Callableê³¼ Future

### 3-1. Callable

- Runnableê³¼ ê±°ì˜ ìœ ì‚¬í•˜ì§€ë§Œ ë°˜í™˜ ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

### 3-2. Future

- ë¹„ë™ê¸°ì ì¸ ì‘ì—…ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

### 3-3. ë©”ì†Œë“œ ì‚´í´ë³´ê¸°

#### 3-3-1. ê²°ê³¼ ë°˜í™˜ : get()

- í•´ë‹¹ ë©”ì†Œë“œëŠ” `ë¸”ë¡í‚¹ ì½œ`ì´ê¸°ì— ë©”ì†Œë“œ í˜¸ì¶œì‹œì ë¶€í„° ì½”ë“œì‹¤í–‰ ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤.
- íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

```java
ExecutorService executorService = Executors.newSingleThreadExecutor();
Callable<String> hello = () ->{
    Thread.sleep(2000L);
    return "Hello";
};
Future<String> submit = executorService.submit(hello);
System.out.println("Started!");

submit.get();// blocking

System.out.println("End");
executorService.shutdown();

/*
Started!
(2ì´ˆ ë’¤)
End
*/
```

#### 3-3-2. ì‘ì—… ìƒíƒœ í™•ì¸ - isDone()

```java
ExecutorService executorService = Executors.newSingleThreadExecutor();
Callable<String> hello = () ->{
    Thread.sleep(2000L);
    return "Hello";
};
Future<String> helloFuture = executorService.submit(hello);
System.out.println(helloFuture.isDone());
System.out.println("Started!");

helloFuture.get(); // blocking

System.out.println(helloFuture.isDone());
System.out.println("End");
executorService.shutdown();

/* ì‹¤í–‰ ê²°ê³¼
false
Started!
true
End
*/
```

#### 3-3-3. ì‘ì—… ì·¨ì†Œ : cancel()

- ì¸ì ê°’ìœ¼ë¡œ í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì“°ë ˆë“œ interrupt ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.
- true ì´ë©´ í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì“°ë ˆë“œë¥¼ interruptí•˜ê³  ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‘ì—…ì´ ëë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤.

```java
ExecutorService executorService = Executors.newSingleThreadExecutor();
Callable<String> hello = () ->{
    Thread.sleep(2000L);
    return "Hello";
};
Future<String> helloFuture = executorService.submit(hello);
System.out.println(helloFuture.isDone());
System.out.println("Started!");

helloFuture.cancel(false);

System.out.println(helloFuture.isDone());
System.out.println("End");

helloFuture.get();
executorService.shutdown();

/* ì‹¤í–‰ ê²°ê³¼
false
Started!
true
End
Exception in thread "main" java.util.concurrent.CancellationException...
*/
```

**helloFuture.cancel(false)**

- í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‘ì—…ì„ ê¸°ë‹¤ë¦° ë’¤ ì‘ì—…ì„ ì·¨ì†Œí•œë‹¤.
- ì‘ì—…ì´ ì·¨ì†Œë˜ì–´ ì¢…ë£Œë˜ì—ˆê¸° ë•Œë¬¸ì— ì•„ë˜ì— `helloFuture.isDone()`ì€ trueê°€ ë°˜í™˜ë˜ë©°, ì´ë¯¸ ì·¨ì†Œí•œ ì‘ì—…ì„ get() í˜¸ì¶œí•˜ëŠ” ì‹œì ì—ëŠ” `CancellationException` ì˜ˆì™¸ê°€ ë°œìƒ

#### 3-3-4. ì—¬ëŸ¬ ì‘ì—… ë™ì‹œ ì‹¤í–‰ : `invokeAll()`

```java
ExecutorService executorService = Executors.newSingleThreadExecutor();
LocalDateTime start = LocalDateTime.now();
Callable<String> hello = () ->{
    Thread.sleep(2000L);
    return "Hello";
};
Callable<String> java = () ->{
    Thread.sleep(3000L);
    return "java";
};
Callable<String> youngjun = () ->{
    Thread.sleep(1000L);
    return "youngjun";
};

List<Future<String>> futures = 
        executorService.invokeAll(Arrays.asList(hello, java, youngjun));
for (Future<String> future : futures) {
    System.out.println(future.get());
}
LocalDateTime end = LocalDateTime.now();
Duration between = Duration.between(start, end);
System.out.println(between.getSeconds());

/*
Hello
java
youngjun
6
*/
```

- `invokeAll()` ë©”ì†Œë“œëŠ” íƒœìŠ¤í¬ê°€ ëª¨ë‘ ëë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ê°’ë“¤ì„ ë°˜í™˜
    - ì‹±ê¸€ ì“°ë ˆë“œì´ê¸° ë•Œë¬¸ì— 6ì´ˆê°€ ì†Œìš”ëœë‹¤.
    - future listë¥¼ ë°˜í™˜í•˜ê³  **ì „ë¶€ ëë‚ ë•Œê¹Œì§€ holdingëœë‹¤.**
    - ë„˜ê²¨ì¤€ Callable listê°€ ì •ìƒ ì²˜ë¦¬ë˜ë“  exceptionì´ ë°œìƒí•˜ë“  ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ë³¸ë‹¤.
    - ë™ì‘ì¤‘ì— ì „ë‹¬ë°›ì€ listê°€ ë³€ê²½ë˜ë©´ ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤
    - ë„˜ê²¨ì¤€ list ìˆœì„œëŒ€ë¡œ ê²°ê³¼ futureë¥¼ ë‹´ì•„ì„œ ë„˜ê²¨ì¤€ë‹¤.

  **ë°œìƒí•  ìˆ˜ ìˆëŠ” Exception**

    - *InterruptedException* : ë™ì‘ì´ ì¢…ë£Œë˜ì§€ ì•Šì€(ë™ì‘ì¤‘ì¸) taskê°€ ì·¨ì†Œ ë˜ì—ˆì„ ë•Œ
    - *NullPointerException* : í•¨ìˆ˜ì˜ paramì¤‘ nullì´ ìˆì„ ë•Œ
    - *RejectedExecutionException* : taskë¥¼ poolì— ë„£ì„ìˆ˜ ì—†ì„ ë•Œ.

- ë”°ë¼ì„œ ê°€ì¥ ë¨¼ì € ì™„ë£Œëœ ì‘ì—…ë§Œ ë°˜í™˜í•´ë„ ê´œì°®ë‹¤ë©´ invokeAllì„ ì“°ê¸°ì—ëŠ” ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤.
    - ê·¸ëŸ´ ë•Œ ì‚¬ìš© í•  ìˆ˜ ìˆëŠ” ë©”ì†Œë“œê°€ `invokeAny` ì´ë‹¤.

#### 3-3-5. ì—¬ëŸ¬ ì‘ì—… ë™ì‹œ ì‹¤í–‰ : invokeAny()

- ë™ì‹œì— ì‹¤í–‰í•œ ì‘ì—… ì¤‘ì— ì œì¼ ì§§ê²Œ ê±¸ë¦¬ëŠ” ì‘ì—… ë§Œí¼ ì‹œê°„ì´ ê±¸ë¦°ë‹¤.
- **ë¸”ë¡í‚¹ ì½œ**ì´ë‹¤.

```java
String result = executorService.invokeAny(Arrays.asList(hello, java, youngjun));
System.out.println("result = " + result);

/* ì‹¤í–‰ ê²°ê³¼
result = youngjun
*/
```

> ì£¼ì˜í•  ì ì€, ì‹±ê¸€ ì“°ë ˆë“œë¡œ í•  ê²½ìš° ë¨¼ì € ë“¤ì–´ê°„ ìˆœì„œëŒ€ë¡œ ë‚˜ì˜¤ê²Œ ëœë‹¤ëŠ” ì ì´ë‹¤.

```java
public static void main(String[] args) throws InterruptedException, ExecutionException {
    ExecutorService executorService = Executors.newSingleThreadExecutor();

    Callable<String> hello = () -> {
        Thread.sleep(2000L);
        return "Hello";
    };

    Callable<String> java = () -> {
        Thread.sleep(3000L);
        return "java";
    };

    Callable<String> youngjun = () -> {
        Thread.sleep(1000L);
        return "youngjun";
    };

    String s = executorService.invokeAny(Arrays.asList(hello, java, youngjun));
    System.out.println(s);

    executorService.shutdown();
}

/* ì‹¤í–‰ ê²°ê³¼
Hello
*/

```

## 4. CompletableFuture (1)

### 4-1. ê°œìš”

> ìë°”ì—ì„œ ë¹„ë™ê¸°(Asynchronous)í”„ë¡œê·¸ë˜ë°ì„ ê°€ëŠ¥í•˜ê²Œí•˜ëŠ” ì¸í„°í˜ì´ìŠ¤.  
> Futureì˜ ì œì•½ì‚¬í•­ë“¤ì„ í•´ê²°í•œë‹¤.

#### 4-1-1. Future ì œì•½

- ì˜ˆì™¸ ì²˜ë¦¬ìš© APIë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì—¬ëŸ¬ Futureë¥¼ ì¡°í•©í•  ìˆ˜ ì—†ë‹¤. (ex: Eventì •ë³´ë¥¼ ë°›ì•„ ë‹¤ìŒ Eventì— ì°¸ì„í•  íšŒì›ëª©ë¡ì¡°íšŒ)
- Futureë¥¼ ì™¸ë¶€ì—ì„œ ì™„ë£Œì‹œí‚¬ ìˆ˜ ì—†ë‹¤. ì·¨ì†Œí•˜ê±°ë‚˜, get()ì— íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•  ìˆ˜ëŠ” ìˆë‹¤.
- get()ì„ í˜¸ì¶œí•˜ê¸° ì „ê¹Œì§€ëŠ” futureë¥¼ ë‹¤ë£° ìˆ˜ ì—†ë‹¤.

```java
ExecutorService executorService = Executors.newFixedThreadPool(4);
Future<String> future = executorService.submit(() -> "hello");
...//TODO
future.get();
...//TODO
```

- ì—¬ê¸°ì„œ futureëŠ” `blocking call`

> futureë¥¼ get()ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ë™ì•ˆì—ëŠ” ë‹¤ë¥¸ ì‘ì—…ë“¤ì˜ ìˆ˜í–‰ì´ ì•ˆëœë‹¤ëŠ” ì˜ë¯¸ì´ê³  ê·¸ ê¸°ê°„ì´ ê¸¸ì–´ì§ˆìˆ˜ë¡ ì„±ëŠ¥ì€ ë–¨ì–´ì§ˆìˆ˜ ë°–ì— ì—†ë‹¤.

### 4-2. CompletableFuture

> Futureì™€ CompletionStageë¥¼ êµ¬í˜„í•˜ëŠ” êµ¬í˜„ì²´

- ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ì§€ì›í•˜ëŠ” ë©”ì„œë“œ
- ìˆœì„œì˜ ì˜ì¡´ê´€ê³„ë¥¼ ë§ëŠ” ìŠ¤ë ˆë“œ í”„ë¡œê·¸ë˜ë°
- ì½œë°±ì„ ì§€ì›í•˜ê¸°ë„ í•˜ë©° ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ í•˜ë‚˜ë¡œ ë¬¶ì–´ ì²˜ë¦¬í•˜ê¸°ì—ë„ ìš©ì´

*`public class CompletableFuture<T> implements Future<T>, CompletionStage<T>{...}`*

```java
CompletableFuture<String> future = new CompletableFuture<>();
future.complete("youngjun");
System.out.println("future = " + future.get());
//-------------OR --------------
CompletableFuture<String> future = CompletableFuture.completedFuture("youngjun");
System.out.println("future = " + future.get());
```

#### 4-2-1. ë¹„ë™ê¸°ë¡œ ì‘ì—… ì‹¤í–‰í•˜ê¸°

- ë¦¬í„´ê°’ì´ ì—†ëŠ” ê²½ìš°: **runAsync()**

    ```java
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        System.out.println("Hello" + Thread.currentThread().getName());
    });
    future.get();
    ```

- ë¦¬í„´ê°’ì´ ìˆëŠ” ê²½ìš°: **supplyAsync()**

    ```java
    CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello" + Thread.currentThread().getName());
        return "Hello";
    });
    future.get();
    ```

- ì›í•˜ëŠ” **Executor**(ì“°ë ˆë“œí’€)ë¥¼ ì‚¬ìš©í•´ì„œ ì‹¤í–‰í•  ìˆ˜ë„ ìˆë‹¤. (ê¸°ë³¸ì€ **ForkJoinPool.commonPool()**)

#### 4-2-2. ì½œë°± ì œê³µí•˜ê¸°

- *`thenApply(Function)`*

  > ë¦¬í„´ê°’ì„ ë°›ì•„ì„œ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì½œë°±

    ```java
    CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello" + Thread.currentThread().getName());
        return "Hello";
    }).thenApply((s)->{
        System.out.println("content: "+s);
        System.out.println(Thread.currentThread().getName());
        return "HelloAsync";
    });
    System.out.println(future.get());
    ```

    - Javascriptì˜ Promise ì™€ ìœ ì‚¬í•œ í˜•íƒœ
    - `supplyAsync`ì˜ ëŒë‹¤í‘œí˜„ì‹ì—ì„œ ë°˜í™˜ëœ Helloë¼ëŠ” ê°’ì€ ì²´ì´ë‹ëœ ë©”ì†Œë“œ `thenApply`ì˜ ì¸ìê°’ìœ¼ë¡œ ë“¤ì–´ê°€ê³  ì‚¬ìš© ê°€ëŠ¥
    - ê·¸ë¦¬ê³  ë” ì´ìƒ ì²´ì´ë‹ëœ ë©”ì†Œë“œê°€ ì—†ê¸° ë•Œë¬¸ì— returnê°’ì¸ HelloAsyncëŠ” ë°˜í™˜ë˜ì–´ futureë¡œ ë“¤ì–´ê°€ê³  get()ì„í†µí•´ ë°›ì„ ìˆ˜ ìˆë‹¤.

- *`thenAccept(Consumer)`*

  > ë¦¬í„´ê°’ì„ ë°›ì•„ ë˜ ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë° ë°˜í™˜ê°’ì€ ì—†ëŠ” ì½œë°± (ë¦¬í„´ x)

    ```java
    CompletableFuture<Void> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello" + Thread.currentThread().getName());
        return "Hello";
    }).thenAccept((s)->{
        System.out.println("content: "+s);
        System.out.println(Thread.currentThread().getName());
            // return ì—†ë‹¤.
    });
    future.get();
    ```

- *`thenRun(Runnable)`*

  > ë¦¬í„´ê°’ì„ ë°›ì§€ ì•Šê³  ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ì½œë°±

    ```java
    CompletableFuture<Void> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello" + Thread.currentThread().getName());
        return "hello";
    }).thenRun(()->{
        System.out.println(Thread.currentThread().getName());
    });
    future.get();
    ```

#### *ParallelStream vs. CompletableFuture*

- from [Java 8 in Action](https://www.manning.com/books/java-8-in-action)
- **ParallelStream** : **I/Oê°€ í¬í•¨ë˜ì§€ ì•Šì€ ê³„ì‚° ì¤‘ì‹¬**ì˜ ë™ì‘ì„ ì‹¤í–‰í•  ë•ŒëŠ” ìŠ¤íŠ¸ë¦¼ ì¸í„°í˜ì´ìŠ¤ê°€ ê°€ì¥ êµ¬í˜„í•˜ê¸° ê°„ë‹¤í•˜ë©° íš¨ìœ¨ì ì¼ ìˆ˜ ìˆë‹¤(ëª¨ë“  ìŠ¤ë ˆë“œê°€ ê³„ì‚° ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ìƒí™©ì—ì„œëŠ” í”„ë¡œì„¸ì„œ ì½”ì–´ ìˆ˜ ì´ìƒì˜ ì“°ë ˆë“œë¥¼ ê°€ì§ˆ í•„ìš”ê°€ ì—†ë‹¤).
- **CompletableFuture** : ë°˜ë©´ ì‘ì—…ì´ **I/Oë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì‘ì—…ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰**í•  ë•ŒëŠ” `CompletableFuture`ê°€ ë” ë§ì€ ìœ ì—°ì„±ì„ ì œê³µí•˜ë©° ëŒ€ê¸°/ê³„ì‚°(W/C)ì˜ ë¹„ìœ¨ì— ì í•©í•œ ìŠ¤ë ˆë“œ ìˆ˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤. íŠ¹íˆ ìŠ¤íŠ¸ë¦¼ì˜ ê²Œìœ¼ë¥¸ íŠ¹ì„± ë•Œë¬¸ì— ìŠ¤íŠ¸ë¦¼ì—ì„œ I/Oë¥¼ ì‹¤ì œë¡œ ì–¸ì œ ì²˜ë¦¬í•  ì§€ ì˜ˆì¸¡í•˜ê¸° ì–´ë ¤ìš´ ë¬¸ì œë„ ìˆë‹¤.
- [fahd.blog: Java 8: CompletableFuture vs Parallel Stream](http://fahdshariff.blogspot.kr/2016/06/java-8-completablefuture-vs-parallel.html)

## 5. CompletableFuture (2)

### 5-1. CompletableFuture ì¡°í•© ë©”ì†Œë“œ

#### 5-1-1. thenCompose()

- ë‘ ì‘ì—…ì´ ì„œë¡œ ì´ì–´ì„œ ì‹¤í–‰í•˜ë„ë¡ ì¡°í•©í•˜ë©° ì—°ê´€ëœ futureê°„ì— ë§ì´ ì‚¬ìš©

```java
public class App {
    public static void main(String[] args) throws InterruptedException, ExecutionException {
        CompletableFuture<String> helloFuture = CompletableFuture.supplyAsync(() -> {
            System.out.println("Hello " + Thread.currentThread().getName());
            return "Hello";
        });

        CompletableFuture<String> future = helloFuture.thenCompose(App::getWorldFuture);
        System.out.println(future.get());

    }
    private static CompletableFuture<String> getWorldFuture(String message) {
        return CompletableFuture.supplyAsync(() -> {
            System.out.println("World " + Thread.currentThread().getName());
            return message + " World";
        });
    }
}

/*
Hello ForkJoinPool.commonPool-worker-3
World ForkJoinPool.commonPool-worker-5
Hello World
*/
```

#### 5-1-2. thenCombine()

- **ë‘ ì‘ì—…ì„ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ë‘˜ ë‹¤ ì¢…ë£Œ í–ˆì„ë•Œ ì½œë°± ì‹¤í–‰.**

```java
public static void main(String[] args) throws InterruptedException, ExecutionException {
    CompletableFuture<String> msFuture = CompletableFuture.supplyAsync(() -> {
        System.out.println("MicroSoft " + Thread.currentThread().getName());
        return "MicroSoft";
    });

    CompletableFuture<String> appleFuture = CompletableFuture.supplyAsync(() -> {
        System.out.println("Apple " + Thread.currentThread().getName());
        return "Apple";
    });

    CompletableFuture<String> resultFuture = msFuture.thenCombine(appleFuture, (i, j) -> i + " " + j);
    
    System.out.println(resultFuture.get());
}
```

#### 5-1-3. allOf()

- ì—¬ëŸ¬ ì‘ì—…ì„ ëª¨ë‘ ì‹¤í–‰í•˜ê³  ëª¨ë“  ì‘ì—… ê²°ê³¼ì— ì½œë°± ì‹¤í–‰

```java
public static void main(String[] args) throws InterruptedException, ExecutionException {
    CompletableFuture<String> msFuture = CompletableFuture.supplyAsync(() -> {
        System.out.println("MicroSoft " + Thread.currentThread().getName());
        return "MicroSoft";
    });

    CompletableFuture<String> appleFuture = CompletableFuture.supplyAsync(() -> {
        System.out.println("Apple " + Thread.currentThread().getName());
        return "Apple";
    });
    List<CompletableFuture<String>> futures = Arrays.asList(msFuture, appleFuture);

    CompletableFuture<List<String>> results =
            CompletableFuture.allOf(futures.toArray(new CompletableFuture[futures.size()]))
                    .thenApply(v -> futures.stream()
                            .map(CompletableFuture::join)
                            .collect(Collectors.toList()));
    results.get().forEach(System.out::println);
}
```

#### 5-1-4. anyOf()

- ì—¬ëŸ¬ ì‘ì—… ì¤‘ ê°€ì¥ ëë‚œ í•˜ë‚˜ì˜ ê²°ê³¼ë¥¼ ì½œë°±ì— ë„˜ê²¨ ì‹¤í–‰

```java
CompletableFuture<String> msFuture = CompletableFuture.supplyAsync(() -> {
    System.out.println("MicroSoft " + Thread.currentThread().getName());
    return "MicroSoft";
});

CompletableFuture<String> appleFuture = CompletableFuture.supplyAsync(() -> {
    System.out.println("Apple " + Thread.currentThread().getName());
    return "Apple";
});

CompletableFuture<Void> future = CompletableFuture.anyOf(msFuture, appleFuture).thenAccept(System.out::println);
future.get();
```

### 5-2. ì˜ˆì™¸ ì²˜ë¦¬ ë©”ì†Œë“œ

#### 5-2-1. exeptionally(Function)

```java
boolean throwError = true;

CompletableFuture<String> msFuture = CompletableFuture.supplyAsync(() -> {
    if (throwError) {
        throw new IllegalArgumentException();
    }

    System.out.println("MicroSoft " + Thread.currentThread().getName());
    return "MicroSoft";
}).exceptionally(ex->{
    System.out.println(ex);
    return "Error";
});

System.out.println(msFuture.get());
```

#### 5-2-2. handle(BiFunction)

```java
boolean throwError = false;

CompletableFuture<String> msFuture = CompletableFuture.supplyAsync(() -> {
    if (throwError) {
        throw new IllegalArgumentException();
    }

    System.out.println("MicroSoft " + Thread.currentThread().getName());
    return "MicroSoft";
}).handle((result, ex)->{
    if (Objects.nonNull(ex)) {
        System.out.println(ex);
        return "ERROR";
    }
    return result;
});

System.out.println(msFuture.get());
```

### 5-3. CompletableFuture ë¥¼ ì–¸ì œ ì“¸ ìˆ˜ ìˆì„ê¹Œ

- ì•„ë˜ëŠ” microservices.io ì‚¬ì´íŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ì˜ˆì œì´ë‹¤.

![image](https://user-images.githubusercontent.com/42997924/142424985-840b9ddd-6f97-49f1-abc8-f34fa9f5918b.png)

- CompletableFuture ë¥¼ ì‚¬ìš©í•  ë§Œí•œ ë¶€ë¶„ì€ API GATEWAY, Storefront WebApp ë¼ê³  í•  ìˆ˜ ìˆë‹¤. ì´ìœ ëŠ” Account, Inventory, Shipping Service ëŠ” DATA BASE ì™€ ì—°ë™í•˜ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤. java í™˜ê²½ì—ì„œ RDBMS ì—°ë™ì‹œì— ì•„ì§ Async í•œ ì¸í„°í˜ì´ìŠ¤ ë°©ì‹ì„ ì œê³µí•˜ê³  ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— Async ê°œë°œì„ í•´ì„œ í° íš¨ê³¼ë¥¼ ì–»ê¸° ë¶€ì¡±í•˜ë‹¤.
- í•˜ì§€ë§Œ GATEWAY ë“±ì€ REST Service ì™€ ì—°ë™í•˜ê¸° ë•Œë¬¸ì— Async ë¥¼ í†µí•œ ì„±ëŠ¥ íš¨ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. (Blocking Thread ë¬¸ì œ í•´ê²° ë“±)

**Reference**

- [https://www.hungrydiver.co.kr/bbs/detail/develop?id=2](https://www.hungrydiver.co.kr/bbs/detail/develop?id=2)
- [https://kwonnam.pe.kr/wiki/java/8/completable_future](https://kwonnam.pe.kr/wiki/java/8/completable_future)
- [https://huisam.tistory.com/entry/completableFuture](https://huisam.tistory.com/entry/completableFuture)
- [https://tourspace.tistory.com/137](https://tourspace.tistory.com/137)
- [https://bbubbush.tistory.com/23](https://bbubbush.tistory.com/23)