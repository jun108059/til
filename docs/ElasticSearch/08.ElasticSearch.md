# ElasticSearch Bucket Aggregation

![img](../.vuepress/public/images/img-es/1.elasticsearchLogo.png)  

---

### ì‹¤ìŠµ í™˜ê²½

- ğŸ’¡ Elasticsearch 7.9.0
- ğŸ’¡ Windows 10
- ğŸ’¡ Git Bash

---

### Aggregationì´ë€?

ê°„ë‹¨íˆ ì„¤ëª…í•˜ë©´ ElasticSearchì•ˆ Documentì˜ ì¡°í•©ì„ í†µí•´ ê°’ì„ ë„ì¶œí•  ë•Œ ì“°ì´ëŠ” ë°©ë²•ì´ë‹¤.

ê·¸ ì¤‘ Bucket Aggregationì€ `group by`ë¡œ ì´í•´í•˜ë©´ ëœë‹¤.

ê·¸ë£¹ìœ¼ë¡œ íŠ¹ì • ì§€ì„ ë•Œ ì‚¬ìš©í•˜ë©´ ìœ ìš©í•˜ë‹¤.

ì´ì „ ì‹¤ìŠµì—ì„œ ë§Œë“¤ì—ˆë˜ `basketball` indexë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ìƒì„±í•´ì„œ

Mapping ë¶€í„° ì‹œì¼œë³´ì.


### index ì‚­ì œí•˜ê¸°

`curl -XDELETE http://localhost:9200/basketball`

### index ìƒì„±í•˜ê¸°

`curl -XPUT localhost:9200/basketball`

---

## Type Mapping

ì´ì œ ìƒˆë¡œìš´ indexì— ë°ì´í„°ë¥¼ `Mapping`ì‹œì¼œë³´ì.  

`basketball_mapping.json` íŒŒì¼ ë‚´ìš©

```JSON
{
	"record" : {
		"properties" : {
			"team" : {
				"type" : "text",
				"fielddata" : true
			},
			"name" : {
				"type" : "text",
				"fielddata" : true
			},
			"points" : {
				"type" : "long"
			},
			"rebounds" : {
				"type" : "long"
			},
			"assists" : {
				"type" : "long"
			},
			"blocks" : {
				"type" : "long"
			},
			"submit_date" : {
				"type" : "date",
				"format" : "yyyy-MM-dd"
			}
		}
	}
}
```

recodeë¼ëŠ” `type` ì•ˆì— ë‹¤ì–‘í•œ `properties`ê°€ ìˆëŠ”ë°

`fielddata : true` ê°’ì€ aggregationí•  ë•Œ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•´ë‘ì—ˆë‹¤.

Mappingì„ ESì— ì ìš©í•´ë³´ì.

```bash
$ curl -XPUT 'http://localhost:9200/basketball/record/_mapping?include_type_name=true&pretty' -d @basketball_mapping.json -H 'Content-Type: application/json'
```

---

## Documentsì— Sample data Bulk í•˜ê¸°

Sample dataëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

`twoteam_basketball.json` íŒŒì¼ ë‚´ìš©

```JSON
{ "index" : { "_index" : "basketball", "_type" : "record", "_id" : "1" } }
{"team" : "Chicago","name" : "Michael Jordan", "points" : 30,"rebounds" : 3,"assists" : 4, "blocks" : 3, "submit_date" : "1996-10-11"}
{ "index" : { "_index" : "basketball", "_type" : "record", "_id" : "2" } }
{"team" : "Chicago","name" : "Michael Jordan","points" : 20,"rebounds" : 5,"assists" : 8, "blocks" : 4, "submit_date" : "1996-10-13"}
{ "index" : { "_index" : "basketball", "_type" : "record", "_id" : "3" } }
{"team" : "LA","name" : "Kobe Bryant","points" : 30,"rebounds" : 2,"assists" : 8, "blocks" : 5, "submit_date" : "2014-10-13"}
{ "index" : { "_index" : "basketball", "_type" : "record", "_id" : "4" } }
{"team" : "LA","name" : "Kobe Bryant","points" : 40,"rebounds" : 4,"assists" : 8, "blocks" : 6, "submit_date" : "2014-11-13"}
```

ìœ„ì—ì„œ í™•ì¸í•œ sample ë°ì´í„°ë¥¼ Bulk í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì„ ì…ë ¥í•˜ì.

### âœ” Bulk í•˜ê¸°

```bash
$ curl -XPOST http://localhost:9200/_bulk?pretty --data-binary @twoteam_basketball.json -H 'Content-Type: application/json'
```

> JSON íŒŒì¼ì€ í•­ìƒ ë§ˆì§€ë§‰ì— newlineì„ ì‚½ì…í•´ì£¼ì.

---

## Term Aggregation ì‹¤ìŠµ

### Group by Team!

Teamìœ¼ë¡œ ê·¸ë£¹ì„ ë‚˜ëˆ ë³´ì.

`terms_aggs.json` íŒŒì¼ ë‚´ìš©

```JSON
{
	"size" : 0,
	"aggs" : {
		"players" : {
			"terms" : {
				"field" : "team"
			}
		}
	}
}
```

`size:0` - ë‹¤ë¥¸ ì—¬ëŸ¬ ì •ë³´ë¥¼ í‘œì‹œí•˜ì§€ ì•Šê³  ê²°ê³¼ë§Œ ë„ì¶œ

`players` - Aggregation name

`terms` - term Aggregationì„ ì‚¬ìš©í•œë‹¤ê³  ì •ì˜ 

---

ì•„ë˜ ëª…ë ¹ì–´ë¡œ Termì„ í™•ì¸í•´ë³´ì

```bash
$ curl -XGET 'http://localhost:9200/_search?pretty' --data-binary @terms_aggs.json -H 'Content-Type: application/json'
```

í˜„ì¬ íŒ€ ìƒí™©ì„ í‘œë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

|  | Doc1 | Doc2 | Doc3 | Doc4 |
|:---:|:---:|:---:|:---:|:---:|
| `Team` | Chicago | Chicago | LA | LA |

`Term Aggregraion` ê²°ê³¼ ì˜ˆìƒí–ˆë˜ëŒ€ë¡œ ê° íŒ€ì´ 2ê°œì”© count ëœ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ê²°ê³¼

```bash
{
  # ... ìƒëµ
  "aggregations" : {
    "players" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "chicago",
          "doc_count" : 2
        },
        {
          "key" : "la",
          "doc_count" : 2
        }
      ]
    }
  }
}
```

---

## ë³µì¡í•œ í†µê³„ ë¶„ì„ ì˜ˆì œ

í†µê³„ë‚˜ ë¶„ì„ìœ¼ë¡œ ë³´ê¸°ì—” ì¡°ê¸ˆ ë¬´ë¦¬ê°€ ìˆì–´ ê³ ë ¤í•  ì‚¬í•­ì„ ëŠ˜ë ¤ì„œ ì‹¤ìŠµí•´ë³´ì.

ì‹¤ì œ ë†êµ¬ê²½ê¸° ì²˜ëŸ¼ ê°’ì„ ì ìœ¼ë©´ ì•„ë˜ì™€ ê°™ì´ ìë£Œë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

|  | Doc1 | Doc2 | Doc3 | Doc4 |
|:---:|:---:|:---:|:---:|:---:|
| `Team` | Chicago | Chicago | LA | LA |
| `Name` | Michael | Michael | Kobe | Kobe |
| `Points` | 30 | 20 | 30 | 40 |
| `Rebounds` | 3 | 5 | 2 | 4 |
| `Assists` | 4 | 8 | 8 | 8 |
| `blocks` | 3 | 4 | 5 | 6 |

íŒ€ì„ ë¶„ë¥˜í•˜ê³ , ê° íŒ€ ë³„ë¡œ ì„±ì ì„ ë³´ëŠ” í†µê³„ë¥¼ ë§Œë“¤ì–´ë³´ì.

```JSON
{
	"size" : 0,
	"aggs" : {
		"team_stats" : {
			"terms" : {
				"field" : "team"
			},
			"aggs" : {
				"stats_score" : {
					"stats" : {
						"field" : "points"
					}
				}
			}
		}
	}
}
```

- íŒ€ë³„ë¡œ documentë¥¼ ë¬¶ì–´ì£¼ê³ 
- ê° íŒ€ë³„ë¡œ ì ìˆ˜ë³„ stats í†µê³„ë¥¼ ë°˜í™˜

```bash
$ curl -XGET http://localhost:9200/_search?pretty --data-binary @stats_by_team.json -H 'Content-Type: application/json'
```

ê²°ê³¼

```bash
# ... ìƒëµ
"aggregations" : {
    "team_stats" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "chicago",
          "doc_count" : 2,
          "stats_score" : {
            "count" : 2,
            "min" : 20.0,
            "max" : 30.0,
            "avg" : 25.0,
            "sum" : 50.0
          }
        },
        {
          "key" : "la",
          "doc_count" : 2,
          "stats_score" : {
            "count" : 2,
            "min" : 30.0,
            "max" : 40.0,
            "avg" : 35.0,
            "sum" : 70.0
          }
        }
      ]
    }
#... ìƒëµ
```

ChicagoíŒ€ê³¼ LAíŒ€ ê°ê° ì ìˆ˜ í†µê³„ê°€ ë‚˜íƒ€ë‚˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

> ë³¸ í¬ìŠ¤íŒ…ì€ `Inflearn`ì˜ [ELK ìŠ¤íƒ (ElasticSearch, Logstash, Kibana) ìœ¼ë¡œ ë°ì´í„° ë¶„ì„](https://www.inflearn.com/course/elk-%EC%8A%A4%ED%83%9D-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%B6%84%EC%84%9D) ê°•ì˜ë¥¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

---
