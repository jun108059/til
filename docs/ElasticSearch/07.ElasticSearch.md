# ElasticSearch Metric Aggregation

![img](../.vuepress/public/images/img-es/1.elasticsearchLogo.png)  

---

### ì‹¤ìŠµ í™˜ê²½

- ğŸ’¡ Elasticsearch 7.9.0
- ğŸ’¡ Windows 10
- ğŸ’¡ Git Bash

---

### Aggregationì´ë€?

ê°„ë‹¨íˆ ì„¤ëª…í•˜ë©´ ElasticSearchì•ˆ Documentì˜ ì¡°í•©ì„ í†µí•´ ê°’ì„ ë„ì¶œí•  ë•Œ ì“°ì´ëŠ” ë°©ë²•ì´ë‹¤.

ê·¸ ì¤‘ Metric Aggregationì€ `ì‚°ìˆ `ì— ì‚¬ìš©ëœë‹¤.

í‰ê· , ìµœëŒ€, ìµœì†Œê°’ ë“±ì„ êµ¬í•  ë•Œ ìœ ìš©í•˜ë‹¤!

ë¨¼ì € sample ë°ì´í„°ë¥¼ `bulk`í•´ë³´ì.

[sample ë°ì´í„° ì†ŒìŠ¤](https://github.com/jun108059/til/blob/master/practice/ElasticSearch/simple_basketball.json)

```JSON
{ "index" : { "_index" : "basketball", "_type" : "record", "_id" : "1" } }
{"team" : "Chicago Bulls","name" : "Michael Jordan", "points" : 30,"rebounds" : 3,"assists" : 4, "submit_date" : "1996-10-11"}
{ "index" : { "_index" : "basketball", "_type" : "record", "_id" : "2" } }
{"team" : "Chicago Bulls","name" : "Michael Jordan","points" : 20,"rebounds" : 5,"assists" : 8, "submit_date" : "1996-10-11"}
```

> 20ì ì˜ pointë¥¼ ê¸°ë¡í•œ ê²ƒê³¼ 30ì ì˜ pointë¥¼ ê¸°ë¡í•œ ê²ƒë§Œ ê¸°ì–µí•˜ë©´ ëœë‹¤.

---

## 1. Indexì— ë°ì´í„° Bulkí•˜ê¸°

ìœ„ì—ì„œ í™•ì¸í•œ sample ë°ì´í„°ë¥¼ ì‚½ì…í•˜ë©´

`curl -XPOST "/ESì£¼ì†Œ/"_bulk --data-binary @"fileëª…".json`

```bash
$ curl -XPOST 'http://localhost:9200/_bulk?pretty' --data-binary @simple_basketball.json -H 'Content-Type: application/json'
```

ê²°ê³¼

```bash
{
  "took" : 423,
  "errors" : false,
  "items" : [
    {
      "index" : {
        "_index" : "basketball",
        "_type" : "record",
        "_id" : "1",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 2,
          "successful" : 1,
          "failed" : 0
        },
        "_seq_no" : 0,
        "_primary_term" : 1,
        "status" : 201
      }
    },
    {
      "index" : {
        "_index" : "basketball",
        "_type" : "record",
        "_id" : "2",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 2,
          "successful" : 1,
          "failed" : 0
        },
        "_seq_no" : 1,
        "_primary_term" : 1,
        "status" : 201
      }
    }
  ]
}
```

ì˜ bulk ëë‹¤!

---

## 2. âœ” AVG Aggregation

í‰ê· ì„ êµ¬í•˜ëŠ” Aggregationì„ ë¨¼ì € ì‹¤ìŠµí•´ë³´ì.

`avg_points_aggs.json` íŒŒì¼ì´ë‹¤.

```JSON
{
	"size" : 0,
	"aggs" : {
		"avg_score" : {
			"avg" : {
				"field" : "points"
			}
		}
	}
}
```

`size 0` = ê²°ê³¼ ê°’ì— ë³´ê³ ì‹¶ì€ ê°’ë§Œ ì¶œë ¥

`aggs` = aggregationì˜ Keyword

`avg` = í‰ê·  ê°’ì„ êµ¬í•˜ëŠ” aggregationì„ ì‚¬ìš©

field ì¤‘ pointsì˜ í‰ê·  ê°’ì„ êµ¬í•˜ëŠ” ì½”ë“œì´ë‹¤.

`curl` ì»¤ë©˜ë“œë¡œ ëŒë ¤ì„œ í™•ì¸í•´ë³´ì.

```bash
$ curl -XGET 'http://localhost:9200//_search?pretty' --data-binary @avg_points_aggs.json -H 'Content-Type: application/json'
```

ê²°ê³¼

```bash
{
  "took" : 12,
  "timed_out" : false,
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 26,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "avg_score" : {
      "value" : 25.0
    }
  }
}
```

point ê°’ì¸ 20ê³¼ 30ì˜ í‰ê· ì¸ `value`ê°€ **25.0**ìœ¼ë¡œ ì˜ ì¶œë ¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## 3. âœ” Max/Min Aggregation

ìµœëŒ€ê°’ì„ êµ¬í•˜ëŠ” Aggregationë„ ì‹¤ìŠµí•´ë³´ì.

`max_points_aggs.json` íŒŒì¼ì´ë‹¤.

```JSON
{
	"size" : 0,
	"aggs" : {
		"max_score" : {
			"max" : {
				"field" : "points"
			}
		}
	}
}
```

ìœ„ì—ì„œ ì‹¤ìŠµí•œ `avg`ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆê³ 

`avg`ê°€ `max`ë¡œ ë°”ë€Œì—ˆë‹¤.

`curl` ì»¤ë©˜ë“œë¡œ ëŒë ¤ì„œ í™•ì¸í•´ë³´ì.

```bash
$ curl -XGET 'http://localhost:9200//_search?pretty' --data-binary @max_points_aggs.json -H 'Content-Type: application/json'
```

ê²°ê³¼

```bash
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 26,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "max_score" : {
      "value" : 30.0
    }
  }
}
```

ìµœëŒ€ê°’ì¸ 30ì´ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

ìµœì†Œê°’ë„ ë§ˆì°¬ê°€ì§€ì´ë‹¤.

`min_points_aggs.json` íŒŒì¼ì„ ë³´ë©´

```JSON
{
	"size" : 0,
	"aggs" : {
		"min_score" : {
			"min" : {
				"field" : "points"
			}
		}
	}
}
```

`max`ì—ì„œ `min`ìœ¼ë¡œ ë³€ê²½í•´ì£¼ê³  ë˜‘ê°™ì€ ì‹¤ìŠµì„ ì§„í–‰í•˜ë©´

ìµœì†Œê°’ì¸ 20ì´ ì¶œë ¥ëœë‹¤.

---

## 4. âœ” Sum Aggregation

í•©ì„ êµ¬í•˜ëŠ” Aggregationë„ ì‹¤ìŠµí•´ë³´ì.

`sum_points_aggs.json` íŒŒì¼ì´ë‹¤.

```JSON
{
	"size" : 0,
	"aggs" : {
		"sum_score" : {
			"sum" : {
				"field" : "points"
			}
		}
	}
}
```

ë˜‘ê°™ì€ í˜•ì‹ì´ë©° `sum` keywordë§Œ ì…ë ¥í•´ì¤¬ë‹¤.

`curl` ì»¤ë©˜ë“œë¡œ ëŒë ¤ì„œ í™•ì¸í•´ë³´ì.

```bash
$ curl -XGET 'http://localhost:9200//_search?pretty' --data-binary @sum_points_aggs.json -H 'Content-Type: application/json'
```

ê²°ê³¼

```bash
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 26,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "sum_score" : {
      "value" : 50.0
    }
  }
}
```

20ê³¼ 30ì˜ í•©ì¸ `50`ì´ ì¶œë ¥ëœë‹¤.

---

## 5. âœ” STATS Aggregation í•œë²ˆì— í™•ì¸í•˜ê¸°

ìœ„ì—ì„œ ì‹¤ìŠµí•œ ë‚´ìš©ì„ í•œë²ˆì— ë³¼ ìˆ˜ ìˆëŠ” ëª…ë ¹ë„ ìˆë‹¤. 

`stats_points_aggs.json` íŒŒì¼ì´ë‹¤.

```JSON
{
	"size" : 0,
	"aggs" : {
		"stats_score" : {
			"stats" : {
				"field" : "points"
			}
		}
	}
}
```

`curl` ì»¤ë©˜ë“œë¡œ ëŒë ¤ì„œ í™•ì¸í•´ë³´ì.

```bash
$ curl -XGET 'http://localhost:9200//_search?pretty' --data-binary @stats_points_aggs.json -H 'Content-Type: application/json'
```

ê²°ê³¼
```bash
# ... ì• ìƒëµ
"aggregations" : {
    "stats_score" : {
      "count" : 2,
      "min" : 20.0,
      "max" : 30.0,
      "avg" : 25.0,
      "sum" : 50.0
    }
  }
# ... ë’¤ ìƒëµ
```

ìœ„ ê²°ê³¼ì™€ ê°™ì´ `min`, `max`, `avg`, `sum` ëª¨ë‘ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

> ë³¸ í¬ìŠ¤íŒ…ì€ `Inflearn`ì˜ [ELK ìŠ¤íƒ (ElasticSearch, Logstash, Kibana) ìœ¼ë¡œ ë°ì´í„° ë¶„ì„](https://www.inflearn.com/course/elk-%EC%8A%A4%ED%83%9D-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%B6%84%EC%84%9D) ê°•ì˜ë¥¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

---
